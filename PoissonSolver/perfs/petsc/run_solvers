#!/bin/bash -l
#SBATCH --job-name perfs
#SBATCH --time=00:30:00
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=36
#SBATCH --partition biggpu

export LD_LIBRARY_PATH=/softs/local_intel/petsc/3.13.4/lib:$LD_LIBRARY_PATH
nb_cpu=$SLURM_NPROCS

module list

# mpirun -np $nb_cpu ./poisson.out $1 $1 -ksp_type cg -ksp_norm_type unpreconditioned \
#     -pc_type gamg -gamg_est_ksp_type cg -gamg_est_ksp_max_it 10 -pc_gamg_process_eq_limit 500 \
#     -pc_gamg_coarse_eq_limit 1000 -mg_levels_esteig_ksp_type cg -mg_levels_esteig_ksp_max_it 10 \
#     -mg_levels_pc_type sor -mg_levels_ksp_type richardson

run_cg_gamg() {
    for nn in 101 201 401 801 2001 4001
    do
        mpirun -np "$nb_cpu" ./poisson.out $nn $nn "$1"/solver_cg_gamg_"$2"_procs_$nn.log -ksp_type cg -ksp_rtol "$3" -pc_type gamg
    done
}

run_cg_hypre_boomerang() {
    for nn in 101 201 401 801 2001 4001
    do
        mpirun -np "$nb_cpu" ./poisson.out $nn $nn "$1"/solver_cg_gamg_"$2"_procs_$nn.log -ksp_type cg -ksp_rtol "$3" -pc_type hypre -pc_hypre_type boomeramg
    done
}

run_lu() {
    for nn in 101 201 401 801 2001 4001
    do
        mpirun -np "$nb_cpu" ./poisson.out $nn $nn "$1"/solver_cg_gamg_"$2"_procs_$nn.log -ksp_type preonly -pc_type lu
    done
}

rtol="1.0e-3"
casename=log/solvers/cg_gamg/rtol_1e-3
mkdir -p "${casename}"
run_cg_gamg "${casename}" "${nb_cpu}" "${rtol}"

rtol="1.0e-6"
casename=log/solvers/cg_gamg/rtol_1e-6
mkdir -p "${casename}"
run_cg_gamg "${casename}" "${nb_cpu}" "${rtol}"

rtol="1.0e-10"
casename=log/solvers/cg_gamg/rtol_1e-10
mkdir -p "${casename}"
run_cg_gamg "${casename}" "${nb_cpu}" "${rtol}"

rtol="1.0e-3"
casename=log/solvers/hypre_boomerang/rtol_1e-3
mkdir -p "${casename}"
run_cg_gamg "${casename}" "${nb_cpu}" "${rtol}"

rtol="1.0e-6"
casename=log/solvers/hypre_boomerang/rtol_1e-6
mkdir -p "${casename}"
run_cg_gamg "${casename}" "${nb_cpu}" "${rtol}"

rtol="1.0e-10"
casename=log/solvers/hypre_boomerang/rtol_1e-10
mkdir -p "${casename}"
run_cg_gamg "${casename}" "${nb_cpu}" "${rtol}"

casename=log/solvers/direct_lu
mkdir -p "${casename}"
run_lu "${casename}" "${nb_cpu}"

